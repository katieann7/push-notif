name: Notify on Main Branch Push

on:
  push:
    branches:
      - main

permissions:
  issues: write   # Needed for creating Issues

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
    steps:

      # 1Ô∏è‚É£ Create GitHub Issue and notify the pusher
      - name: Create GitHub Issue Notification
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "üöÄ Push to main branch",
              body: `
@${context.actor} pushed to the **main** branch.

**Author:** ${context.payload.head_commit.author.name}
**Message:** ${context.payload.head_commit.message}
**Compare:** ${context.payload.compare}
              `
            })

      # 2Ô∏è‚É£ Map GitHub username to email
      - name: Map GitHub Username to Email
        id: set_email
        uses: actions/github-script@v7
        with:
          script: |
            const emailMap = {
              "kai": "kai@example.com",
              "ann": "ann@example.com",
              "octocat": "octocat@example.com"
            };

            const username = "${{ github.actor }}";
            const email = emailMap[username];

            if (!email) {
              // fallback to a default team email
              return "team@example.com";
            }

            console.log(`Mapped GitHub user ${username} to email: ${email}`);
            return email;

      # 3Ô∏è‚É£ Send Email Notification
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.SMTP_SERVER }}
          server_port: ${{ env.SMTP_PORT }}
          username: ${{ env.SMTP_USERNAME }}
          password: ${{ env.SMTP_PASSWORD }}
          from: ${{ env.SMTP_USERNAME }}
          to: ${{ steps.set_email.outputs.result }}
          subject: "üöÄ Push to main branch"
          body: |
            A push was made to the **main** branch.

            Author: ${{ github.event.head_commit.author.name }}
            Message: ${{ github.event.head_commit.message }}
            Compare: ${{ github.event.compare }}
