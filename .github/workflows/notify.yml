name: Notify on Main Branch Push

on:
  push:
    branches:
      - main

permissions:
  issues: write   # For GitHub Issue creation

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
    steps:
      # 1Ô∏è‚É£ Create GitHub Issue
      - name: Create GitHub Issue Notification
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "üöÄ Push to main branch",
              body: `
              A push was made to the **main** branch.

              **Author:** ${context.payload.head_commit.author.name}
              **Message:** ${context.payload.head_commit.message}
              **Compare:** ${context.payload.compare}
              `
            })

      # 2Ô∏è‚É£ Send Email based on username
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.SMTP_SERVER }}
          server_port: ${{ env.SMTP_PORT }}
          username: ${{ env.SMTP_USERNAME }}
          password: ${{ env.SMTP_PASSWORD }}
          from: ${{ env.SMTP_USERNAME }}
          to: ${{ steps.set_email.outputs.email }}  # output from username mapping
          subject: "üöÄ Push to main branch"
          body: |
            A push was made to the **main** branch.

            Author: ${{ github.event.head_commit.author.name }}
            Message: ${{ github.event.head_commit.message }}
            Compare: ${{ github.event.compare }}

      # 3Ô∏è‚É£ Map GitHub username to email
      - name: Set Email for GitHub User
        id: set_email
        uses: actions/github-script@v7
        with:
          script: |
            // Mapping GitHub usernames to emails
            const emailMap = {
              "kai": "kai@example.com",
              "ann": "ann@example.com",
              "octocat": "octocat@example.com"
            };

            const username = "${{ github.actor }}"; // who pushed
            const email = emailMap[username];

            if (!email) {
              throw new Error(`No email found for GitHub username: ${username}`);
            }

            return email;
